name: Atomic Red team Demo
run-name: ${{ github.actor }} is running a atomic red team test
on: [push]
jobs:
  Atomic-Red-Team-Run:
    runs-on: macos-13
    steps:
      - name: Check out repository code
        uses: actions/checkout@v3
      - run: echo "💡 The ${{ github.repository }} repository has been cloned to the runner."
      - run: echo "🖥️ The workflow is now ready to test your code on the runner."
      - name: List files in the repository
        run: |
          ls ${{ github.workspace }}

      - name: Install Powershell Core
        run: brew install --cask powershell

      - name: install Atomic red team
        run: IEX (IWR 'https://raw.githubusercontent.com/redcanaryco/invoke-atomicredteam/master/install-atomicredteam.ps1' -UseBasicParsing);Install-AtomicRedTeam -InstallPath "~/.local/powershell/Modules"
        shell: pwsh
      - run: ls ~/.local/powershell/Modules

      - name: add to powershell profile
        run: New-Item -ItemType File -Path ~/.config/powershell/Microsoft.PowerShell_profile.ps1 -Force
        shell: pwsh
      - run: echo "Import-Module ~/.local/powershell/Modules/invoke-atomicredteam/" > ~/.config/powershell/Microsoft.PowerShell_profile.ps1
      - run: ls ~/.local/powershell/Modules
      - run: ls ~/.config/powershell
      - run: cat ~/.config/powershell/Microsoft.PowerShell_profile.ps1
      - name: Test invoke atomic
        run: Get-Help Invoke-AtomicTest
        shell: pwsh

      - name: get atomic tests folder
        run: git clone --filter=tree:0 https://github.com/redcanaryco/atomic-red-team.git

      - name: create fake .bash_history
        run: echo "password" >> ~/.bash_history
      - run: cat ~/.bash_history
      - run: Invoke-AtomicTest T1552.003-1 -CheckPrereqs -PathToAtomicsFolder "./atomic-red-team/atomics"
        shell: pwsh
      - name: Run atomic test
        run: Invoke-AtomicTest T1552.003-1 -PathToAtomicsFolder "./atomic-red-team/atomics" -ExecutionLogPath "~/executionlog.json" -LoggingModule "Attire-ExecutionLogger" -TimeoutSeconds 60; return $true
        shell: pwsh
      - name: eslogger stop
        run: csrutil status

      - name: test jq
        run: jq

      - name: Logs
        run: cat ~/executionlog.json
      - name: Archive production artifacts
        uses: actions/upload-artifact@v3
        with:
          name: Atomic red team Execution log
          path: |
            ~/executionlog.json